<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Table</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        table {
            width: 85%;
            margin: 2rem auto;
            border-collapse: collapse;
        }
        td {
            padding: 1rem;
            /* border: 1px solid #ccc; */
            position: relative;
        }
        .controls {
            display: none;
        }
        tr:hover .controls {
            display: inline;
            cursor: pointer;
        }
        .dropdown {
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <table id="mainTable">
        <tbody>
            <tr id="generateRow">
                <td>
                    generate <input type="number" min="1" value="5" style="width:3em;" id="jurorCount"> jurors interactively
                </td>
            </tr>
            <tr id="noFilesRow">
                <td style="color: #888;">No files yet.</td>
            </tr>
            <!-- Filename rows will be inserted here -->
            <tr id="uploadRow">
                <td>
                    <button type="button" style="color: white" id="uploadButton">Upload</button>
                    <input type="file" id="fileInput" style="display:none;" multiple onchange="handleFiles(event)">
                </td>
            </tr>
            <tr id="repeatRow" style="display: none;">
                <td>
                    repeat <input type="number" min="1" value="10" style="width:3em;" id="repeatCount"> times
                </td>
            </tr>
            <tr id="evaluateRow" style="display: none;">
                <td>
                    evaluate 
                    <label><input type="checkbox" id="cb_participation"> participation</label>
                    <label><input type="checkbox" id="cb_quality"> quality</label>
                    <label><input type="checkbox" id="cb_arguments"> arguments</label>
                </td>
            </tr>
            <tr id="runRow" style="display: none;">
                <td>
                    <button id="runButton" onclick="runProcess()" style="/* padding: 0.5em 1em; */ background: #007bff; color: white; /* border: none; */ /* border-radius: 4px; */ cursor: pointer;">Run Process</button>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        const state = {};
        let uploadedFiles = []; // Store file objects, not just filenames

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up file upload');
            const uploadButton = document.getElementById('uploadButton');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadButton && fileInput) {
                uploadButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Upload button clicked');
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function(event) {
                    console.log('File input change event fired');
                    handleFiles(event);
                });
                
                // Also listen for input event as fallback
                fileInput.addEventListener('input', function(event) {
                    console.log('File input input event fired');
                    handleFiles(event);
                });
                
                console.log('Event listeners attached successfully');
            } else {
                console.error('Upload elements not found');
            }
        });

        function showButton(i) {
            const btn = document.getElementById(`btn_${i}`);
            if (btn) btn.style.display = 'inline';
        }

        function hideButton(i) {
            const btn = document.getElementById(`btn_${i}`);
            if (btn && !state[i]) btn.style.display = 'none';
        }

        function togglePlay(i) {
            const btn = document.getElementById(`btn_${i}`);
            state[i] = !state[i];
            if (btn) {
                btn.textContent = state[i] ? "⏸" : "▶";
                btn.style.display = 'inline';
            }
        }

        function updateRowVisibility() {
            const hasFiles = uploadedFiles.length > 0;
            const repeatRow = document.getElementById('repeatRow');
            const evaluateRow = document.getElementById('evaluateRow');
            const runRow = document.getElementById('runRow');
            
            if (repeatRow) repeatRow.style.display = hasFiles ? '' : 'none';
            if (evaluateRow) evaluateRow.style.display = hasFiles ? '' : 'none';
            if (runRow) runRow.style.display = hasFiles ? '' : 'none';
        }

        function handleFiles(event) {
            console.log('handleFiles called');
            const files = Array.from(event.target.files);
            console.log('Files selected:', files);
            
            if (files.length > 0) {
                console.log('Removing no files row');
                removeNoFilesRow();
                files.forEach(file => {
                    console.log('Adding file row for:', file.name);
                    // Store the actual file object with its name
                    const fileObj = {
                        file: file,
                        name: file.name
                    };
                    addFileRow(fileObj);
                });
                updateRowVisibility();
            } else {
                console.log('No files selected');
            }
            
            // Reset input so same file can be uploaded again if needed
            event.target.value = '';
        }

        function addFileRow(fileObj) {
            console.log('addFileRow called with:', fileObj.name);
            // Check if file already exists by name
            if (uploadedFiles.some(f => f.name === fileObj.name)) {
                console.log('File already exists, skipping:', fileObj.name);
                return;
            }
            
            uploadedFiles.push(fileObj);
            console.log('Current uploaded files:', uploadedFiles.map(f => f.name));
            
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const uploadRow = document.getElementById('uploadRow');
            
            if (!table || !uploadRow) {
                console.error('Table or uploadRow not found');
                return;
            }
            
            const row = document.createElement('tr');
            row.setAttribute('data-filename', fileObj.name);
            row.innerHTML = `
                <td>
                    <div class="file-row-container">
                        <span style="font-weight:bold;">${fileObj.name}</span>
                        <div class="file-row-controls">
                            <label><input type="radio" name="category_${fileObj.name}" value="juror" checked> juror</label>
                            <label><input type="radio" name="category_${fileObj.name}" value="case"> case</label>
                            <label>weight: <input type="number" id="weight_${fileObj.name}" min="0" step="1" value="100"></label>
                            <button type="button" style="color: white" onclick="deleteFileRow('${fileObj.name}')">Delete</button>
                        </div>
                    </div>
                </td>
            `;
            
            // Insert before uploadRow (so files appear above the upload row)
            table.insertBefore(row, uploadRow);
            console.log('File row added successfully');
        }

        function deleteFileRow(filename) {
            uploadedFiles = uploadedFiles.filter(f => f.name !== filename);
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const rows = table.querySelectorAll('tr[data-filename]');
            rows.forEach(row => {
                if (row.getAttribute('data-filename') === filename) {
                    table.removeChild(row);
                }
            });
            if (uploadedFiles.length === 0) addNoFilesRow();
            updateRowVisibility();
        }

        function removeNoFilesRow() {
            const row = document.getElementById('noFilesRow');
            if (row) {
                row.parentNode.removeChild(row);
            }
        }

        function addNoFilesRow() {
            if (document.getElementById('noFilesRow')) return;
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const uploadRow = document.getElementById('uploadRow');
            const row = document.createElement('tr');
            row.id = 'noFilesRow';
            row.innerHTML = '<td style="color: #888;">No files yet.</td>';
            table.insertBefore(row, uploadRow);
        }

        async function uploadFilesToServer() {
            if (uploadedFiles.length === 0) {
                console.log('No files to upload');
                return false;
            }

            try {
                console.log('Clearing existing files and uploading...');
                
                // Create FormData to send actual files
                const formData = new FormData();
                
                // Add files and their metadata
                uploadedFiles.forEach(fileObj => {
                    const radioButtons = document.querySelectorAll(`input[name="category_${fileObj.name}"]:checked`);
                    const category = radioButtons.length > 0 ? radioButtons[0].value : 'juror';
                    
                    const weightInput = document.getElementById(`weight_${fileObj.name}`);
                    const weight = weightInput ? parseInt(weightInput.value) || 100 : 100;
                    
                    // Add the actual file
                    formData.append('files', fileObj.file);
                    // Add metadata
                    formData.append('categories', category);
                    formData.append('weights', weight.toString());
                });

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('Files uploaded successfully:', result);
                    return true;
                } else {
                    console.error('Upload error:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('Upload error:', error);
                return false;
            }
        }

        async function runProcess() {
            // First upload files
            const uploadSuccess = await uploadFilesToServer();
            if (!uploadSuccess) return;

            // Get form values
            const jurorCount = document.getElementById('jurorCount').value;
            const repeatCount = document.getElementById('repeatCount').value;
            
            const evaluationOptions = [];
            if (document.getElementById('cb_participation').checked) evaluationOptions.push('participation');
            if (document.getElementById('cb_quality').checked) evaluationOptions.push('quality');
            if (document.getElementById('cb_arguments').checked) evaluationOptions.push('arguments');

            try {
                console.log('Starting notebook execution...');
                
                // Create output area for streaming results
                let outputArea = document.getElementById('outputArea');
                if (!outputArea) {
                    outputArea = document.createElement('div');
                    outputArea.id = 'outputArea';
                    outputArea.style.cssText = `
                        margin-top: 1em;
                        padding: 1em;
                        border: 1px solid #ccc;
                        max-height: 400px;
                        overflow-y: auto;
                        white-space: pre-wrap;
                        font-family: monospace;
                        font-size: 12px;
                    `;
                    // Append to the table body
                    const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
                    const outputRow = document.createElement('tr');
                    const outputCell = document.createElement('td');
                    outputCell.appendChild(outputArea);
                    outputRow.appendChild(outputCell);
                    table.appendChild(outputRow);
                }
                outputArea.innerHTML = '';
                
                // Use Server-Sent Events to stream notebook execution
                const eventSource = new EventSource('/run_notebook?' + new URLSearchParams({
                    juror_count: parseInt(jurorCount),
                    repeat_count: parseInt(repeatCount),
                    evaluation_options: JSON.stringify(evaluationOptions)
                }));
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.status === 'started') {
                            outputArea.innerHTML += `[STARTED] ${data.message}\n`;
                        } else if (data.status === 'output') {
                            outputArea.innerHTML += data.message + '\n';
                            outputArea.scrollTop = outputArea.scrollHeight;
                        } else if (data.status === 'completed') {
                            outputArea.innerHTML += `[COMPLETED] ${data.message}\n`;
                            eventSource.close();
                        } else if (data.status === 'error') {
                            outputArea.innerHTML += `[ERROR] ${data.message}\n`;
                            eventSource.close();
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                        outputArea.innerHTML += `[ERROR] Failed to parse server response\n`;
                    }
                };
                
                eventSource.onerror = function(event) {
                    console.error('SSE error:', event);
                    outputArea.innerHTML += `[ERROR] Connection error occurred\n`;
                    eventSource.close();
                };
                
            } catch (error) {
                console.error('Run error:', error);
            }
        }
    </script>
</body>
</html>