<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#13161e">
    <title>Interactive Table</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- Force dark mode always -->
    <style>
        /* Override color scheme detection to always use dark mode */
        html {
            color-scheme: dark !important;
        }
        
        /* Force dark theme variables to be active regardless of user preference */
        :root {
            color-scheme: dark !important;
            --pico-background-color: rgb(19, 22.5, 30.5) !important;
            --pico-color: #c2c7d0 !important;
            --pico-text-selection-color: rgba(1, 170, 255, 0.1875) !important;
            --pico-muted-color: #7b8495 !important;
            --pico-muted-border-color: #202632 !important;
            --pico-primary: #01aaff !important;
            --pico-primary-background: #0172ad !important;
            --pico-primary-border: var(--pico-primary-background) !important;
            --pico-primary-underline: rgba(1, 170, 255, 0.5) !important;
            --pico-primary-hover: #79c0ff !important;
            --pico-primary-hover-background: #017fc0 !important;
            --pico-primary-hover-border: var(--pico-primary-hover-background) !important;
            --pico-primary-hover-underline: var(--pico-primary-hover) !important;
            --pico-primary-focus: rgba(1, 170, 255, 0.375) !important;
            --pico-primary-inverse: #fff !important;
            --pico-secondary: #969eaf !important;
            --pico-secondary-background: #525f7a !important;
            --pico-secondary-border: var(--pico-secondary-background) !important;
            --pico-secondary-underline: rgba(150, 158, 175, 0.5) !important;
            --pico-secondary-hover: #b3b9c5 !important;
            --pico-secondary-hover-background: #5a677f !important;
            --pico-secondary-hover-border: var(--pico-secondary-hover-background) !important;
            --pico-secondary-hover-underline: var(--pico-secondary-hover) !important;
            --pico-secondary-focus: rgba(150, 158, 175, 0.375) !important;
            --pico-secondary-inverse: #fff !important;
            --pico-contrast: #ffffff !important;
            --pico-contrast-background: #ffffff !important;
            --pico-contrast-border: var(--pico-contrast-background) !important;
            --pico-contrast-underline: rgba(255, 255, 255, 0.5) !important;
            --pico-contrast-hover: #ffffff !important;
            --pico-contrast-hover-background: #ffffff !important;
            --pico-contrast-hover-border: var(--pico-contrast-hover-background) !important;
            --pico-contrast-hover-underline: var(--pico-contrast-hover) !important;
            --pico-contrast-focus: rgba(255, 255, 255, 0.375) !important;
            --pico-contrast-inverse: #000 !important;
            --pico-box-shadow: 0.0145rem 0.029rem 0.174rem rgba(27, 40, 50, 0.01698), 0.0335rem 0.067rem 0.402rem rgba(27, 40, 50, 0.024), 0.0625rem 0.125rem 0.75rem rgba(27, 40, 50, 0.03), 0.1125rem 0.225rem 1.35rem rgba(27, 40, 50, 0.036), 0.2085rem 0.417rem 2.502rem rgba(27, 40, 50, 0.04302), 0.5rem 1rem 6rem rgba(27, 40, 50, 0.06), 0 0 0 0.0625rem rgba(27, 40, 50, 0.015) !important;
            --pico-h1-color: #ffffff !important;
            --pico-h2-color: #e1e6ee !important;
            --pico-h3-color: #c2c7d0 !important;
            --pico-h4-color: #c2c7d0 !important;
            --pico-h5-color: #c2c7d0 !important;
            --pico-h6-color: #7b8495 !important;
            --pico-mark-background-color: #d1ecf1 !important;
            --pico-mark-color: #024c5a !important;
            --pico-ins-color: #388e3c !important;
            --pico-del-color: #c62828 !important;
            --pico-blockquote-border-color: var(--pico-muted-border-color) !important;
            --pico-blockquote-footer-color: var(--pico-muted-color) !important;
            --pico-button-box-shadow: 0 0 0 rgba(0, 0, 0, 0) !important;
            --pico-button-hover-box-shadow: 0 0 0 rgba(0, 0, 0, 0) !important;
            --pico-button-focus-box-shadow: 0 0 0 var(--pico-outline-width) var(--pico-primary-focus) !important;
            --pico-form-element-background-color: #11141a !important;
            --pico-form-element-selected-background-color: #1e2734 !important;
            --pico-form-element-border-color: #202632 !important;
            --pico-form-element-color: var(--pico-color) !important;
            --pico-form-element-placeholder-color: var(--pico-muted-color) !important;
            --pico-form-element-active-background-color: var(--pico-form-element-background-color) !important;
            --pico-form-element-active-border-color: var(--pico-primary-border) !important;
            --pico-form-element-focus-color: var(--pico-primary-border) !important;
            --pico-form-element-disabled-opacity: 0.5 !important;
            --pico-form-element-invalid-border-color: #b94a48 !important;
            --pico-form-element-invalid-active-border-color: #a43633 !important;
            --pico-form-element-invalid-focus-color: var(--pico-form-element-invalid-active-border-color) !important;
            --pico-form-element-valid-border-color: #388e3c !important;
            --pico-form-element-valid-active-border-color: #2d7031 !important;
            --pico-form-element-valid-focus-color: var(--pico-form-element-valid-active-border-color) !important;
            --pico-switch-background-color: #424a56 !important;
            --pico-switch-checked-background-color: var(--pico-primary-background) !important;
            --pico-switch-color: var(--pico-primary-inverse) !important;
            --pico-switch-thumb-box-shadow: 0 0 0 rgba(0, 0, 0, 0) !important;
            --pico-range-border-color: #2d3748 !important;
            --pico-range-active-border-color: #475569 !important;
            --pico-range-thumb-border-color: var(--pico-background-color) !important;
            --pico-range-thumb-color: var(--pico-secondary-background) !important;
            --pico-range-thumb-active-color: var(--pico-primary-background) !important;
            --pico-table-border-color: var(--pico-muted-border-color) !important;
            --pico-table-row-stripped-background-color: rgba(88, 96, 109, 0.0375) !important;
            --pico-code-background-color: #1a1d23 !important;
            --pico-code-color: var(--pico-muted-color) !important;
            --pico-code-kbd-background-color: var(--pico-color) !important;
            --pico-code-kbd-color: var(--pico-background-color) !important;
            --pico-code-tag-color: #b4637a !important;
            --pico-code-property-color: #7fdbca !important;
            --pico-code-value-color: #b8cc74 !important;
            --pico-code-comment-color: #8a8a8a !important;
            --pico-accordion-border-color: var(--pico-muted-border-color) !important;
            --pico-accordion-active-summary-color: var(--pico-primary) !important;
            --pico-accordion-close-summary-color: var(--pico-color) !important;
            --pico-accordion-open-summary-color: var(--pico-muted-color) !important;
            --pico-card-background-color: #141720 !important;
            --pico-card-border-color: var(--pico-card-background-color) !important;
            --pico-card-box-shadow: var(--pico-box-shadow) !important;
            --pico-card-sectioning-background-color: #0f1114 !important;
            --pico-dropdown-background-color: #1a1d23 !important;
            --pico-dropdown-border-color: #202632 !important;
            --pico-dropdown-box-shadow: var(--pico-box-shadow) !important;
            --pico-dropdown-color: var(--pico-color) !important;
            --pico-dropdown-hover-background-color: rgba(42, 48, 60, 0.75) !important;
            --pico-loading-spinner-opacity: 0.5 !important;
            --pico-modal-overlay-background-color: rgba(7, 9, 12, 0.8) !important;
            --pico-progress-background-color: #202632 !important;
            --pico-progress-color: var(--pico-primary-background) !important;
            --pico-tooltip-background-color: var(--pico-contrast) !important;
            --pico-tooltip-color: var(--pico-contrast-inverse) !important;
        }
    </style>
    
    <style>
        /* Force sans-serif fonts for all elements */
        body, table, td, th, input, button, label, span, div, p, h1, h2, h3, h4, h5, h6 {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif !important;
        }
        
        table {
            width: 85%;
            margin: 2rem auto;
            border-collapse: collapse;
        }
        td {
            padding: 1rem;
            /* border: 1px solid #ccc; */
            position: relative;
        }
        .controls {
            display: none;
        }
        tr:hover .controls {
            display: inline;
            cursor: pointer;
        }
        .dropdown {
            margin: 0 2px;
        }
        
        /* Number input width fix */
        input[type="number"] {
            width: 80px;
        }
        
        /* Initially hide weight fields */
        .weight-label {
            display: none;
        }
        
        /* Add spacing between form elements */
        .file-row-controls label {
            margin-right: 0.5rem;
        }
        
        /* Remove Pico CSS background and color overrides */
        article {
            background: none !important;
        }
        
        article > footer,
        article > header {
            background-color: transparent !important;
        }
        
        body,
        main {
            background: transparent !important;
        }
        
        /* Fix table styling - remove blue stripes, make rows grey by default */
        table tr {
            background-color: #2a2f3a !important; /* Grey background for all rows */
        }
        
        table tr:hover {
            background-color: #353a47 !important; /* Slightly lighter grey on hover */
        }
        
        /* Override any striped table styling */
        table tr:nth-child(even) {
            background-color: #2a2f3a !important; /* Same grey as other rows */
        }
        
        table tr:nth-child(odd) {
            background-color: #2a2f3a !important; /* Same grey as other rows */
        }
        
        /* Standardize button styling - keep "Run Process" blue, make others grey */
        button, input[type="button"], input[type="submit"], input[type="reset"] {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif !important;
            background-color: #6c757d !important; /* Grey background for all buttons */
            color: white !important;
            border: 1px solid #6c757d !important;
            padding: 0.5em 1em !important;
            border-radius: 4px !important;
            cursor: pointer !important;
        }
        
        button:hover, input[type="button"]:hover, input[type="submit"]:hover, input[type="reset"]:hover {
            background-color: #5a6268 !important; /* Darker grey on hover */
            border-color: #5a6268 !important;
        }
        
        /* Keep "Run Process" button blue */
        #runButton {
            background-color: #007bff !important; /* Blue background for run button */
            border-color: #007bff !important;
        }
        
        #runButton:hover {
            background-color: #0056b3 !important; /* Darker blue on hover */
            border-color: #0056b3 !important;
        }
        
        /* File row highlight animation - dark mode friendly */
        .file-row-highlight {
            background-color: #2a4b8d;
            animation: fadeOutHighlight 3s ease-out forwards;
        }
        
        @keyframes fadeOutHighlight {
            0% { background-color: #2a4b8d; }
            33% { background-color: #2a4b8d; }
            100% { background-color: transparent; }
        }
       
    </style>
</head>
<body>
    <table id="mainTable">
        <tbody>
            <tr id="noFilesRow">
                <td style="color: #7b8495;">No files yet.</td>
            </tr>
            <!-- Filename rows will be inserted here -->
            <tr id="uploadRow">
                <td>
                    <button type="button" id="uploadButton">Upload</button>
                    <button type="button" style="margin-left: 1rem;" id="generateButton" onclick="showGenerateModal()">Generate</button>
                    <input type="file" id="fileInput" style="display:none;" multiple onchange="handleFiles(event)">
                </td>
            </tr>
            <tr id="repeatRow" style="display: none;">
                <td>
                    repeat <input type="number" min="1" value="10" style="width:3em; margin-left: 0.5rem; margin-right: 0.5rem;" id="repeatCount" oninput="updateTimesText()"> <span id="timesText">times</span>
                    <span style="margin-left: 1rem;">
                        <label><input type="radio" name="repeatMode" value="individual" checked onchange="updateWeightVisibility()"> each juror-case combination</label>
                        <label style="margin-left: 0.5rem;"><input type="radio" name="repeatMode" value="overall" onchange="updateWeightVisibility()"> overall</label>
                    </span>
                </td>
            </tr>
            <tr id="evaluateRow" style="display: none;">
                <td>
                    evaluate 
                    <label><input type="checkbox" id="cb_participation"> participation</label>
                    <label><input type="checkbox" id="cb_quality"> quality</label>
                    <label><input type="checkbox" id="cb_arguments"> arguments</label>
                </td>
            </tr>
            <tr id="runRow" style="display: none;">
                <td style="display: flex; justify-content: space-between; align-items: center;">
                    <button id="runButton" onclick="runProcess()">Run Process</button>
                    <button id="stopButton" onclick="stopProcess()" style="display: none;">Stop Process</button>
                    <button type="button" style="display: none;" id="copyOutputButton" onclick="copyOutputToClipboard()">Copy output to clipboard</button>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Generate Jurors Modal -->
    <dialog id="generateModal">
        <article>
            <header>
                <h3>Generate Jurors</h3>
                <!-- <button aria-label="Close" rel="prev" onclick="closeGenerateModal()"></button> -->
            </header>
            <main id="modalContent">
                <div id="inputSection">
                    <p>How many jurors would you like to generate?</p>
                    <input type="number" id="modalJurorCount" min="1" max="20" value="5">
                    <div class="info-note">
                        <strong>Note:</strong> The online generation tool is in beta testing. <br>
                        Some features such as customizable presented distribution are not available online. 
                    </div>
                </div>
                <div id="terminalSection" style="display: none;">
                    <div id="terminalOutput"></div>
                    <div class="terminal-input-container">
                        <input type="text" id="terminalInput" placeholder="Type your response here...">
                        <button onclick="sendTerminalInput()">Send</button>
                    </div>
                    <div class="terminal-help">
                        Common responses: <kbd>A</kbd> (Accept), <kbd>n</kbd> (New suggestion), <kbd>e</kbd> (Enter custom), <kbd>y</kbd>/<kbd>N</kbd> (Yes/No)
                    </div>
                </div>
            </main>
            <footer id="modalFooter">
                <button role="button" class="secondary" onclick="closeGenerateModal()">Cancel</button>
                <button role="button" id="generateConfirmButton" onclick="confirmGenerateJurors()">Generate</button>
            </footer>
        </article>
    </dialog>

    <!-- Script to enforce dark mode -->
    <script>
        // Force dark mode for all users
        document.addEventListener('DOMContentLoaded', function() {
            // Force dark mode at the document level
            document.documentElement.style.colorScheme = 'dark';
            
            // Remove any potential light mode classes that might be added dynamically
            const forceColors = function() {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                document.body.classList.remove('light');
                document.body.classList.add('dark');
                
                // Override any inline styles that might specify light colors
                const allElements = document.querySelectorAll('*');
                allElements.forEach(el => {
                    if (window.getComputedStyle(el).backgroundColor === 'rgb(255, 255, 255)') {
                        el.style.backgroundColor = '#13161e';
                    }
                    if (window.getComputedStyle(el).color === 'rgb(0, 0, 0)') {
                        el.style.color = '#c2c7d0';
                    }
                });
            };
            
            // Run immediately and on any theme change event
            forceColors();
            
            // Observe for class changes on the HTML element (some frameworks do this)
            const observer = new MutationObserver(forceColors);
            observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
            
            // Override any potential matchMedia events
            const mediaQuery = window.matchMedia('(prefers-color-scheme: light)');
            if (mediaQuery.addEventListener) {
                mediaQuery.addEventListener('change', forceColors);
            } else {
                mediaQuery.addListener(forceColors); // For older browsers
            }
        });
    </script>

    <script>
        const state = {};
        let uploadedFiles = []; // Store file objects, not just filenames
        let lastGeneratedFilename = null; // Track the last generated file for highlighting
        let currentEventSource = null; // Track the current process EventSource
        let isProcessRunning = false; // Track if a process is currently running

        // Process state management functions
        function setProcessRunning(running) {
            isProcessRunning = running;
            const body = document.body;
            const runButton = document.getElementById('runButton');
            const stopButton = document.getElementById('stopButton');
            
            if (running) {
                body.classList.add('process-running');
                runButton.style.display = 'none';
                stopButton.style.display = 'inline-block';
            } else {
                body.classList.remove('process-running');
                runButton.style.display = 'inline-block';
                stopButton.style.display = 'none';
            }
        }

        function stopProcess() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            
            setProcessRunning(false);
            
            const outputArea = document.getElementById('outputArea');
            if (outputArea) {
                outputArea.innerHTML += `\n[STOPPED] Process stopped by user\n`;
            }
            
            console.log('Process stopped by user');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up file upload');
            const uploadButton = document.getElementById('uploadButton');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadButton && fileInput) {
                uploadButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Upload button clicked');
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function(event) {
                    console.log('File input change event fired');
                    handleFiles(event);
                });
                
                // Also listen for input event as fallback
                fileInput.addEventListener('input', function(event) {
                    console.log('File input input event fired');
                    handleFiles(event);
                });
                
                console.log('Event listeners attached successfully');
            } else {
                console.error('Upload elements not found');
            }
        });

        function showButton(i) {
            const btn = document.getElementById(`btn_${i}`);
            if (btn) btn.style.display = 'inline';
        }

        function hideButton(i) {
            const btn = document.getElementById(`btn_${i}`);
            if (btn && !state[i]) btn.style.display = 'none';
        }

        function togglePlay(i) {
            const btn = document.getElementById(`btn_${i}`);
            state[i] = !state[i];
            if (btn) {
                btn.textContent = state[i] ? "⏸" : "▶";
                btn.style.display = 'inline';
            }
        }

        function updateRowVisibility() {
            const hasFiles = uploadedFiles.length > 0;
            const repeatRow = document.getElementById('repeatRow');
            const evaluateRow = document.getElementById('evaluateRow');
            const runRow = document.getElementById('runRow');
            
            if (repeatRow) repeatRow.style.display = hasFiles ? '' : 'none';
            if (evaluateRow) evaluateRow.style.display = hasFiles ? '' : 'none';
            if (runRow) runRow.style.display = hasFiles ? '' : 'none';
            
            // Update weight visibility when rows become visible
            if (hasFiles) {
                updateWeightVisibility();
            }
        }

        function updateWeightVisibility() {
            const repeatModeRadio = document.querySelector('input[name="repeatMode"]:checked');
            const showWeights = repeatModeRadio && repeatModeRadio.value === 'overall';
            
            // Show/hide all weight fields
            const weightLabels = document.querySelectorAll('.weight-label');
            weightLabels.forEach(label => {
                label.style.display = showWeights ? 'inline' : 'none';
            });
        }

        function updateTimesText() {
            const repeatCount = document.getElementById('repeatCount');
            const timesText = document.getElementById('timesText');
            
            if (repeatCount && timesText) {
                const count = parseInt(repeatCount.value) || 0;
                timesText.textContent = count === 1 ? 'time' : 'times';
            }
        }

        function copyOutputToClipboard() {
            const outputArea = document.getElementById('outputArea');
            if (outputArea) {
                const text = outputArea.textContent || outputArea.innerText || '';
                
                // Use the modern clipboard API if available
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        console.log('Output copied to clipboard');
                        // Temporarily change button text to show success
                        const button = document.getElementById('copyOutputButton');
                        const originalText = button.textContent;
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy to clipboard:', err);
                        alert('Failed to copy to clipboard');
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        console.log('Output copied to clipboard (fallback)');
                        // Temporarily change button text to show success
                        const button = document.getElementById('copyOutputButton');
                        const originalText = button.textContent;
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        alert('Failed to copy to clipboard');
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }
            } else {
                alert('No output to copy');
            }
        }

        function showGenerateModal() {
            const modal = document.getElementById('generateModal');
            if (modal) {
                modal.showModal();
                // Focus on the input field
                const input = document.getElementById('modalJurorCount');
                if (input) {
                    input.focus();
                    input.select();
                }
            }
        }

        function closeGenerateModal() {
            const modal = document.getElementById('generateModal');
            if (modal) {
                modal.close();
                // Reset modal to initial state
                resetGenerateModal();
                // Highlight the generated file row if available
                highlightGeneratedFileRow();
            }
        }

        function resetGenerateModal() {
            const inputSection = document.getElementById('inputSection');
            const terminalSection = document.getElementById('terminalSection');
            const modalFooter = document.getElementById('modalFooter');
            const terminalOutput = document.getElementById('terminalOutput');
            const terminalInput = document.getElementById('terminalInput');
            const sendButton = terminalInput?.nextElementSibling;
            
            if (inputSection) inputSection.style.display = 'block';
            if (terminalSection) terminalSection.style.display = 'none';
            if (terminalOutput) terminalOutput.innerHTML = '';
            
            // Reset terminal input state
            if (terminalInput) {
                terminalInput.style.display = 'block';
                terminalInput.disabled = false;
                terminalInput.value = '';
            }
            if (sendButton) {
                sendButton.style.display = 'block';
            }
            
            // Reset footer buttons
            if (modalFooter) {
                modalFooter.innerHTML = `
                    <button role="button" class="secondary" onclick="closeGenerateModal()">Cancel</button>
                    <button role="button" id="generateConfirmButton" onclick="confirmGenerateJurors()">Generate</button>
                `;
            }
            
            // Disconnect socket if connected
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function confirmGenerateJurors() {
            const jurorCount = document.getElementById('modalJurorCount').value;
            
            // Switch to terminal view
            const inputSection = document.getElementById('inputSection');
            const terminalSection = document.getElementById('terminalSection');
            const modalFooter = document.getElementById('modalFooter');
            
            if (inputSection) inputSection.style.display = 'none';
            if (terminalSection) {
                terminalSection.style.display = 'block';
                // Focus the terminal input field
                setTimeout(() => {
                    const terminalInput = document.getElementById('terminalInput');
                    if (terminalInput) terminalInput.focus();
                }, 100);
            }
            
            // Update footer to show only close button
            if (modalFooter) {
                modalFooter.innerHTML = `
                    <button role="button" class="secondary" onclick="closeGenerateModal()">Cancel Generation</button>
                `;
            }
            
            // Start the generation process
            generateJurors(jurorCount);
        }

        // WebSocket connection for interactive terminal
        let socket = null;
        
        function processAnsiEscapes(text) {
            // Convert ANSI escape sequences to HTML spans with colors
            const ansiMap = {
                // Reset
                '0': 'color: #fff',
                // Text colors
                '30': 'color: #000', // black
                '31': 'color: #ff0000', // red
                '32': 'color: #00ff00', // green
                '33': 'color: #ffff00', // yellow
                '34': 'color: #0000ff', // blue
                '35': 'color: #ff00ff', // magenta
                '36': 'color: #00ffff', // cyan
                '37': 'color: #fff', // white
                // Bright colors
                '90': 'color: #808080', // bright black (gray)
                '91': 'color: #ff6666', // bright red
                '92': 'color: #66ff66', // bright green
                '93': 'color: #ffff66', // bright yellow
                '94': 'color: #6666ff', // bright blue
                '95': 'color: #ff66ff', // bright magenta
                '96': 'color: #66ffff', // bright cyan
                '97': 'color: #ffffff'  // bright white
            };
            
            // Replace ANSI escape sequences with HTML spans
            return text.replace(/\x1b\[([0-9;]*)m/g, function(match, codes) {
                if (!codes) return '</span>';
                
                const codeList = codes.split(';');
                const styles = codeList.map(code => ansiMap[code]).filter(style => style);
                
                if (styles.length > 0) {
                    return `<span style="${styles.join('; ')}">`;
                }
                return '';
            });
        }
        
        function initializeSocket() {
            if (!socket) {
                socket = io({
                    timeout: 60000,          // 60 second connection timeout
                    pingTimeout: 60000,      // 60 second ping timeout
                    pingInterval: 25000,     // 25 second ping interval
                    reconnection: true,      // Enable automatic reconnection
                    reconnectionAttempts: 5, // Try 5 times to reconnect
                    reconnectionDelay: 1000  // Wait 1 second between attempts
                });
                
                socket.on('terminal_output', function(data) {
                    const terminalOutput = document.getElementById('terminalOutput');
                    if (terminalOutput) {
                        // Process ANSI escape sequences and append as HTML
                        const processedText = processAnsiEscapes(data.data);
                        terminalOutput.innerHTML += processedText;
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    }
                });
                
                socket.on('generation_completed', function(data) {
                    const terminalOutput = document.getElementById('terminalOutput');
                    if (terminalOutput) {
                        terminalOutput.innerHTML += `\n\n<span style="color: white">═══════════════════════════════════════</span>\n`;
                        terminalOutput.innerHTML += `<span style="color: white">✓ GENERATION COMPLETED SUCCESSFULLY!</span>\n`;
                        terminalOutput.innerHTML += `<span style="color: #00ff00">Generated ${data.count} jurors\n`;
                        if (data.filename) {
                            terminalOutput.innerHTML += `Saved as: ${data.filename}\n`;
                        }
                        terminalOutput.innerHTML += `═══════════════════════════════════════</span>\n`;
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    }
                    
                    if (data.filename) {
                        lastGeneratedFilename = data.filename; // Store for highlighting later
                        addGeneratedFileToList(data.filename);
                    }
                    
                    // Hide terminal input since generation is complete
                    const terminalInput = document.getElementById('terminalInput');
                    const sendButton = terminalInput?.nextElementSibling;
                    if (terminalInput) {
                        terminalInput.style.display = 'none';
                        terminalInput.disabled = true;
                    }
                    if (sendButton) {
                        sendButton.style.display = 'none';
                    }
                    
                    // Update footer to show close button
                    const modalFooter = document.getElementById('modalFooter');
                    if (modalFooter) {
                        modalFooter.innerHTML = `
                            <button role="button" onclick="closeGenerateModal()">Close</button>
                        `;
                    }
                });
                
                socket.on('connect', function() {
                    console.log('Connected to server');
                    const terminalOutput = document.getElementById('terminalOutput');
                    if (terminalOutput && terminalOutput.innerHTML.includes('Connecting to interactive terminal')) {
                        terminalOutput.innerHTML += `<span style="color: #00ff00">Connected! Starting generation...</span>\n`;
                    }
                });
                
                socket.on('disconnect', function() {
                    console.log('Disconnected from server');
                    const terminalOutput = document.getElementById('terminalOutput');
                    if (terminalOutput) {
                        terminalOutput.innerHTML += `\n<span style="color: #ff6666">[CONNECTION LOST] Socket disconnected</span>\n`;
                    }
                });
                
                socket.on('connect_error', function(error) {
                    console.error('Connection error:', error);
                    const terminalOutput = document.getElementById('terminalOutput');
                    if (terminalOutput) {
                        terminalOutput.innerHTML += `\n<span style="color: #ff6666">[ERROR] Connection failed: ${error}</span>\n`;
                    }
                });
            }
        }

        function generateJurors(jurorCount) {
            const terminalOutput = document.getElementById('terminalOutput');
            if (!terminalOutput) return;
            
            // Initialize socket connection
            initializeSocket();
            
            terminalOutput.innerHTML = `<span style="color: #00ffff">Connecting to interactive terminal...</span>\n`;
            
            // Start the interactive generation process
            socket.emit('start_interactive_generation', {
                count: parseInt(jurorCount)
            });
        }
        
        function sendTerminalInput() {
            const terminalInput = document.getElementById('terminalInput');
            if (!terminalInput || !socket) return;
            
            const input = terminalInput.value;
            // Allow empty input (just pressing Enter is valid for some prompts)
            // Send input to server
            socket.emit('terminal_input', {
                input: input + '\n'  // Add newline
            });
            
            // Clear input field
            terminalInput.value = '';
        }
        
        // Allow sending input with Enter key
        document.addEventListener('DOMContentLoaded', function() {
            const terminalInput = document.getElementById('terminalInput');
            if (terminalInput) {
                terminalInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendTerminalInput();
                    }
                });
            }
        });

        function addGeneratedFileToList(filename) {
            // Create a file object representation for the generated file
            const fileObj = {
                file: null, // No actual File object for generated files
                name: filename,
                generated: true
            };
            
            // Remove "no files" row if present
            removeNoFilesRow();
            
            // Add file row FIRST (which will also add to uploadedFiles)
            addFileRow(fileObj);
            
            // Update row visibility
            updateRowVisibility();
            
            console.log(`Generated file ${filename} added to file list`);
        }

        // Close modal when clicking outside of it (backdrop click)
        document.getElementById('generateModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeGenerateModal();
            }
        });

        // Escape key handling is automatic with dialog element

        function handleFiles(event) {
            console.log('handleFiles called');
            const files = Array.from(event.target.files);
            console.log('Files selected:', files);
            
            if (files.length > 0) {
                console.log('Removing no files row');
                removeNoFilesRow();
                files.forEach(file => {
                    console.log('Adding file row for:', file.name);
                    // Store the actual file object with its name
                    const fileObj = {
                        file: file,
                        name: file.name
                    };
                    addFileRow(fileObj);
                });
                updateRowVisibility();
            } else {
                console.log('No files selected');
            }
            
            // Reset input so same file can be uploaded again if needed
            event.target.value = '';
        }

        function addFileRow(fileObj) {
            console.log('addFileRow called with:', fileObj.name);
            // Check if file already exists by name
            if (uploadedFiles.some(f => f.name === fileObj.name)) {
                console.log('File already exists, skipping:', fileObj.name);
                return;
            }
            
            uploadedFiles.push(fileObj);
            console.log('Current uploaded files:', uploadedFiles.map(f => f.name));
            
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const uploadRow = document.getElementById('uploadRow');
            
            if (!table || !uploadRow) {
                console.error('Table or uploadRow not found');
                return;
            }
            
            // Check if file has .txt extension to determine default radio selection
            const isTxtFile = fileObj.name.toLowerCase().endsWith('.txt');
            const jurorChecked = isTxtFile ? '' : 'checked';
            const caseChecked = isTxtFile ? 'checked' : '';
            
            const row = document.createElement('tr');
            row.setAttribute('data-filename', fileObj.name);
            row.innerHTML = `
                <td>
                    <div class="file-row-container">
                        <span style="font-weight:bold;">${fileObj.name}</span>
                        <div class="file-row-controls">
                            <label class="weight-label">weight: <input type="number" id="weight_${fileObj.name}" min="0" step="1" value="100"></label>
                            <label><input type="radio" name="category_${fileObj.name}" value="juror" ${jurorChecked}> juror</label>
                            <label><input type="radio" name="category_${fileObj.name}" value="case" ${caseChecked}> case</label>
                            <button type="button" onclick="deleteFileRow('${fileObj.name}')">Delete</button>
                        </div>
                    </div>
                </td>
            `;
            
            // Insert before uploadRow (so files appear above the upload row)
            table.insertBefore(row, uploadRow);
            console.log('File row added successfully');
        }

        function deleteFileRow(filename) {
            uploadedFiles = uploadedFiles.filter(f => f.name !== filename);
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const rows = table.querySelectorAll('tr[data-filename]');
            rows.forEach(row => {
                if (row.getAttribute('data-filename') === filename) {
                    table.removeChild(row);
                }
            });
            if (uploadedFiles.length === 0) addNoFilesRow();
            updateRowVisibility();
        }

        function removeNoFilesRow() {
            const row = document.getElementById('noFilesRow');
            if (row) {
                row.parentNode.removeChild(row);
            }
        }

        function addNoFilesRow() {
            if (document.getElementById('noFilesRow')) return;
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const uploadRow = document.getElementById('uploadRow');
            const row = document.createElement('tr');
            row.id = 'noFilesRow';
            row.innerHTML = '<td style="color: #7b8495;">No files yet.</td>';
            table.insertBefore(row, uploadRow);
        }

        async function uploadFilesToServer() {
            if (uploadedFiles.length === 0) {
                console.log('No files to upload');
                return false;
            }

            try {
                console.log('Clearing existing files and uploading...');
                
                // Create FormData to send actual files
                const formData = new FormData();
                
                // Collect all file metadata (including generated files)
                const allFileMetadata = [];
                
                // Add files and their metadata
                uploadedFiles.forEach(fileObj => {
                    const radioButtons = document.querySelectorAll(`input[name="category_${fileObj.name}"]:checked`);
                    const category = radioButtons.length > 0 ? radioButtons[0].value : 'juror';
                    
                    const weightInput = document.getElementById(`weight_${fileObj.name}`);
                    const weight = weightInput ? parseInt(weightInput.value) || 100 : 100;
                    
                    // Add to metadata list
                    allFileMetadata.push({
                        name: fileObj.name,
                        category: category,
                        weight: weight,
                        generated: fileObj.generated || false
                    });
                    
                    // Only add actual file objects (not generated files)
                    if (fileObj.file && !fileObj.generated) {
                        formData.append('files', fileObj.file);
                        formData.append('categories', category);
                        formData.append('weights', weight.toString());
                    }
                });

                // Add metadata for all files (including generated ones)
                formData.append('allFilesMetadata', JSON.stringify(allFileMetadata));

                // Always send the request (even if no new files) to update metadata
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('Files uploaded successfully:', result);
                    return true;
                } else {
                    console.error('Upload error:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('Upload error:', error);
                return false;
            }
        }

        async function runProcess() {
            // Prevent multiple simultaneous processes
            if (isProcessRunning) {
                console.log('Process already running');
                return;
            }

            // First upload files
            const uploadSuccess = await uploadFilesToServer();
            if (!uploadSuccess) return;

            // Set process as running
            setProcessRunning(true);

            // Get form values
            const repeatCount = document.getElementById('repeatCount').value;
            const repeatModeRadio = document.querySelector('input[name="repeatMode"]:checked');
            const repeatMode = repeatModeRadio ? repeatModeRadio.value : 'individual';
            
            const evaluationOptions = [];
            if (document.getElementById('cb_participation').checked) evaluationOptions.push('participation');
            if (document.getElementById('cb_quality').checked) evaluationOptions.push('quality');
            if (document.getElementById('cb_arguments').checked) evaluationOptions.push('arguments');

            try {
                console.log('Starting notebook execution...');
                
                // Create output area for streaming results
                let outputArea = document.getElementById('outputArea');
                if (!outputArea) {
                    outputArea = document.createElement('div');
                    outputArea.id = 'outputArea';
                    outputArea.style.cssText = `
                        margin-top: 1em;
                        padding: 1em;
                        border: 1px solid #202632;
                        background-color: #141720;
                        color: #c2c7d0;
                        max-height: 400px;
                        overflow-y: auto;
                        white-space: pre-wrap;
                        font-family: monospace;
                        font-size: 12px;
                    `;
                    // Append to the table body
                    const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
                    const outputRow = document.createElement('tr');
                    const outputCell = document.createElement('td');
                    outputCell.appendChild(outputArea);
                    outputRow.appendChild(outputCell);
                    table.appendChild(outputRow);
                    
                    // Show the copy button when output area is created
                    const copyButton = document.getElementById('copyOutputButton');
                    if (copyButton) {
                        copyButton.style.display = 'inline-block';
                    }
                }
                outputArea.innerHTML = '';
                
                // Use Server-Sent Events to stream notebook execution
                currentEventSource = new EventSource('/run_notebook?' + new URLSearchParams({
                    repeat_count: parseInt(repeatCount),
                    repeat_mode: repeatMode,
                    evaluation_options: JSON.stringify(evaluationOptions)
                }));
                
                currentEventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.status === 'started') {
                            outputArea.innerHTML += `[STARTED] ${data.message}\n`;
                        } else if (data.status === 'output') {
                            outputArea.innerHTML += data.message + '\n';
                            outputArea.scrollTop = outputArea.scrollHeight;
                        } else if (data.status === 'completed') {
                            outputArea.innerHTML += `[COMPLETED] ${data.message}\n`;
                            currentEventSource.close();
                            currentEventSource = null;
                            setProcessRunning(false);
                        } else if (data.status === 'error') {
                            outputArea.innerHTML += `[ERROR] ${data.message}\n`;
                            currentEventSource.close();
                            currentEventSource = null;
                            setProcessRunning(false);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                        outputArea.innerHTML += `[ERROR] Failed to parse server response\n`;
                    }
                };
                
                currentEventSource.onerror = function(event) {
                    console.error('SSE error:', event);
                    outputArea.innerHTML += `[ERROR] Connection error occurred\n`;
                    currentEventSource.close();
                    currentEventSource = null;
                    setProcessRunning(false);
                };
                
            } catch (error) {
                console.error('Run error:', error);
                setProcessRunning(false);
                const outputArea = document.getElementById('outputArea');
                if (outputArea) {
                    outputArea.innerHTML += `[ERROR] Failed to start process: ${error.message}\n`;
                }
            }
        }

        function highlightGeneratedFileRow() {
            if (!lastGeneratedFilename) {
                return;
            }
            
            // Find the row with the generated filename
            const rows = document.querySelectorAll('#mainTable tbody tr[data-filename]');
            const targetRow = Array.from(rows).find(row => 
                row.getAttribute('data-filename') === lastGeneratedFilename
            );
            
            if (targetRow) {
                // Add highlight class - CSS animation will handle the fade
                targetRow.classList.add('file-row-highlight');
                
                // Remove class after animation completes (3s animation + small buffer)
                setTimeout(() => {
                    targetRow.classList.remove('file-row-highlight');
                }, 3100);
            }
            
            // Clear the stored filename after highlighting
            lastGeneratedFilename = null;
        }
    </script>
</body>
</html>