<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Table</title>
    <style>
        table {
            width: 60%;
            margin: 2rem auto;
            border-collapse: collapse;
        }
        td {
            padding: 1rem;
            border: 1px solid #ccc;
            position: relative;
        }
        .controls {
            display: none;
        }
        tr:hover .controls {
            display: inline;
            cursor: pointer;
        }
        .dropdown {
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <table id="mainTable">
        <tbody>
            <tr id="generateRow">
                <td>
                    <span class="controls" id="btn_0" onclick="togglePlay(0)">▶</span>
                </td>
                <td>
                    generate <input type="number" min="1" value="5" style="width:3em;" id="jurorCount"> jurors interactively
                </td>
            </tr>
            <tr id="uploadRow">
                <td>
                    <!-- <span class="controls" id="btn_0" onclick="togglePlay(0)">▶</span> -->
                </td>
                <td>
                    <label for="fileInput" id="uploadLabel" style="cursor:pointer; color:blue; text-decoration:underline;">upload</label>
                    <input type="file" id="fileInput" style="display:none;" multiple onchange="handleFiles(event)">
                </td>
            </tr>
            <tr id="noFilesRow">
                <td></td>
                <td style="color: #888;">No files uploaded yet.</td>
            </tr>
            <!-- Filename rows will be inserted here -->
            <tr>
                <td>
                    <span class="controls" id="btn_2" onclick="togglePlay(2)">▶</span>
                </td>
                <td>
                    repeat <input type="number" min="1" value="10" style="width:3em;" id="repeatCount"> times
                </td>
            </tr>
            <tr>
                <td>
                    <span class="controls" id="btn_3" onclick="togglePlay(3)">▶</span>
                </td>
                <td>
                    evaluate 
                    <label><input type="checkbox" id="cb_participation"> participation</label>
                    <label><input type="checkbox" id="cb_quality"> quality</label>
                    <label><input type="checkbox" id="cb_arguments"> arguments</label>
                </td>
            </tr>
            <tr>
                <td>
                    <span class="controls" id="btn_run" onclick="runProcess()">▶</span>
                </td>
                <td>
                    <button id="runButton" onclick="runProcess()" style="padding:0.5em 1em; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Run Process</button>
                    <span id="runStatus" style="margin-left:1em; color:#666;"></span>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        const state = {};
        let uploadedFiles = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up file upload');
            const uploadLabel = document.getElementById('uploadLabel');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadLabel && fileInput) {
                uploadLabel.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Upload label clicked');
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function(event) {
                    console.log('File input change event fired');
                    handleFiles(event);
                });
                
                // Also listen for input event as fallback
                fileInput.addEventListener('input', function(event) {
                    console.log('File input input event fired');
                    handleFiles(event);
                });
                
                console.log('Event listeners attached successfully');
            } else {
                console.error('Upload elements not found');
            }
        });

        function showButton(i) {
            const btn = document.getElementById(`btn_${i}`);
            if (btn) btn.style.display = 'inline';
        }

        function hideButton(i) {
            const btn = document.getElementById(`btn_${i}`);
            if (btn && !state[i]) btn.style.display = 'none';
        }

        function togglePlay(i) {
            const btn = document.getElementById(`btn_${i}`);
            state[i] = !state[i];
            if (btn) {
                btn.textContent = state[i] ? "⏸" : "▶";
                btn.style.display = 'inline';
            }
        }

        function handleFiles(event) {
            console.log('handleFiles called');
            const files = Array.from(event.target.files);
            console.log('Files selected:', files);
            
            if (files.length > 0) {
                console.log('Removing no files row');
                removeNoFilesRow();
                files.forEach(file => {
                    console.log('Adding file row for:', file.name);
                    addFileRow(file.name);
                });
            } else {
                console.log('No files selected');
            }
            
            // Reset input so same file can be uploaded again if needed
            event.target.value = '';
        }

        function addFileRow(filename) {
            console.log('addFileRow called with:', filename);
            if (uploadedFiles.includes(filename)) {
                console.log('File already exists, skipping:', filename);
                return;
            }
            
            uploadedFiles.push(filename);
            console.log('Current uploaded files:', uploadedFiles);
            
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const uploadRow = document.getElementById('uploadRow');
            
            if (!table || !uploadRow) {
                console.error('Table or uploadRow not found');
                return;
            }
            
            const row = document.createElement('tr');
            row.setAttribute('data-filename', filename);
            row.innerHTML = `
                <td></td>
                <td>
                    <span style="font-weight:bold;">${filename}</span>
                    <div style="margin-left:1em; display:inline-block;">
                        <label><input type="radio" name="category_${filename}" value="juror" checked> juror</label>
                        <label style="margin-left:0.5em;"><input type="radio" name="category_${filename}" value="case"> case</label>
                        <button type="button" onclick="deleteFileRow('${filename}')" style="margin-left:1em;">Delete</button>
                    </div>
                </td>
            `;
            
            // Insert after uploadRow but before noFilesRow (if it exists)
            const nextSibling = uploadRow.nextSibling;
            table.insertBefore(row, nextSibling);
            console.log('File row added successfully');
        }

        function deleteFileRow(filename) {
            uploadedFiles = uploadedFiles.filter(f => f !== filename);
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const rows = table.querySelectorAll('tr[data-filename]');
            rows.forEach(row => {
                if (row.getAttribute('data-filename') === filename) {
                    table.removeChild(row);
                }
            });
            if (uploadedFiles.length === 0) addNoFilesRow();
        }

        function removeNoFilesRow() {
            const row = document.getElementById('noFilesRow');
            if (row) {
                row.parentNode.removeChild(row);
            }
        }

        function addNoFilesRow() {
            if (document.getElementById('noFilesRow')) return;
            const table = document.getElementById('mainTable').getElementsByTagName('tbody')[0];
            const uploadRow = document.getElementById('uploadRow');
            const row = document.createElement('tr');
            row.id = 'noFilesRow';
            row.innerHTML = '<td></td><td style="color: #888;">No files uploaded yet.</td>';
            table.insertBefore(row, uploadRow.nextSibling);
        }

        async function uploadFilesToServer() {
            const files = [];
            
            // Collect all uploaded files with their categories
            uploadedFiles.forEach(filename => {
                const radioButtons = document.querySelectorAll(`input[name="category_${filename}"]:checked`);
                const category = radioButtons.length > 0 ? radioButtons[0].value : 'juror';
                files.push({
                    filename: filename,
                    category: category
                });
            });

            if (files.length === 0) {
                document.getElementById('runStatus').textContent = 'No files to upload';
                return false;
            }

            try {
                document.getElementById('runStatus').textContent = 'Clearing existing files and uploading...';
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ files: files })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('Files uploaded successfully:', result);
                    document.getElementById('runStatus').textContent = result.message || `Uploaded ${result.uploaded_files.length} files`;
                    return true;
                } else {
                    document.getElementById('runStatus').textContent = `Upload error: ${result.error}`;
                    return false;
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('runStatus').textContent = `Upload failed: ${error.message}`;
                return false;
            }
        }

        async function runProcess() {
            // First upload files
            const uploadSuccess = await uploadFilesToServer();
            if (!uploadSuccess) return;

            // Get form values
            const jurorCount = document.getElementById('jurorCount').value;
            const repeatCount = document.getElementById('repeatCount').value;
            
            const evaluationOptions = [];
            if (document.getElementById('cb_participation').checked) evaluationOptions.push('participation');
            if (document.getElementById('cb_quality').checked) evaluationOptions.push('quality');
            if (document.getElementById('cb_arguments').checked) evaluationOptions.push('arguments');

            try {
                document.getElementById('runStatus').textContent = 'Starting process...';
                
                const response = await fetch('/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        juror_count: parseInt(jurorCount),
                        repeat_count: parseInt(repeatCount),
                        evaluation_options: evaluationOptions
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('Process started:', result);
                    document.getElementById('runStatus').textContent = result.message;
                    document.getElementById('runStatus').style.color = '#28a745';
                } else {
                    document.getElementById('runStatus').textContent = `Error: ${result.error}`;
                    document.getElementById('runStatus').style.color = '#dc3545';
                }
            } catch (error) {
                console.error('Run error:', error);
                document.getElementById('runStatus').textContent = `Run failed: ${error.message}`;
                document.getElementById('runStatus').style.color = '#dc3545';
            }
        }
    </script>
</body>
</html>